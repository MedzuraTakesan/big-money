# Улучшение плавного скроллинга при парсинге отзывов

## Проблема
При парсинге отзывов использовался резкий скролл с помощью `window.scrollTo()`, который мгновенно перемещал страницу вниз. Это могло вызывать:
- Блокировку со стороны сайтов
- Неполную загрузку ленивого контента
- Нереалистичное поведение, похожее на бота

## Решение

### 1. Новый метод `smoothScroll`
Добавлен метод `smoothScroll` в класс `ReviewsService`, который:
- Имитирует плавную прокрутку колесиком мыши
- Использует функцию плавности `easeInOutCubic` для естественного движения
- Добавляет случайные задержки (10-60ms) для имитации человеческого поведения
- Триггерит события скролла для активации ленивой загрузки

### 2. Циклический скроллинг
Заменен простой скролл на цикл плавного скроллинга:
- **Для Ozon**: до 5 попыток скролла с постепенным увеличением позиции
- **Для Wildberries**: до 4 попыток скролла
- Автоматическое прекращение при стабилизации количества отзывов
- Пауза 1 секунда между скроллами

### 3. Улучшенная логика загрузки
- Мониторинг количества загруженных отзывов в реальном времени
- Адаптивное прекращение скролла при достижении максимума отзывов
- Логирование прогресса для отладки

### 4. Защита персональных данных
- Удален парсинг реальных имен авторов отзывов
- Авторы отзывов анонимизированы: "Автор 1", "Автор 2", и т.д.
- Сохранены только текст отзыва и рейтинг
- Соблюдение принципов GDPR и защиты персональных данных

## Технические детали

### Функция плавности
```javascript
function easeInOutCubic(t) {
    return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
}
```

### Случайные задержки
```javascript
function getRandomDelay() {
    return Math.random() * 50 + 10; // 10-60ms случайная задержка
}
```

### Цикл скроллинга
```javascript
while (scrollAttempt < maxScrollAttempts) {
    const scrollRatio = 0.3 + (scrollAttempt * 0.15);
    await this.smoothScroll(page, Math.min(scrollRatio, 1.0), 2000);
    
    // Проверка количества отзывов
    const currentReviewCount = await page.evaluate(() => { /* ... */ });
    
    if (currentReviewCount === previousReviewCount && currentReviewCount > 0) {
        break; // Прекращаем при стабилизации
    }
    
    scrollAttempt++;
    await new Promise(resolve => setTimeout(resolve, 1000));
}
```

### Анонимизация авторов
```javascript
// Вместо парсинга реальных имен
let author = `Автор ${index + 1}`;
```

## Преимущества

1. **Антидетект**: Более естественное поведение снижает риск блокировки
2. **Полнота данных**: Лучшая загрузка ленивого контента
3. **Стабильность**: Адаптивное прекращение скролла
4. **Отладка**: Подробное логирование процесса
5. **Производительность**: Оптимизированное время выполнения
6. **Конфиденциальность**: Защита персональных данных пользователей

## Тестирование

Для тестирования новой логики используйте:
```bash
node server/test-smooth-scroll.js
```

## Настройки

Можно настроить параметры скроллинга:
- `duration`: продолжительность одного скролла (по умолчанию 2000ms)
- `maxScrollAttempts`: максимальное количество попыток скролла
- `scrollRatio`: шаг увеличения позиции скролла
- `getRandomDelay()`: диапазон случайных задержек

## Соответствие требованиям

- **GDPR**: Анонимизация персональных данных
- **Этика**: Не собираем имена реальных пользователей
- **Безопасность**: Минимизация рисков утечки данных
